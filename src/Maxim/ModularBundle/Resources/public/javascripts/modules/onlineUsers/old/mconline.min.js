/*! mconline 2014-03-01 */
function App(url){this.url=url,this.configs={classes:{progress:"progress progress-striped active",progressbar:"progress-bar progress-bar-success",ping:{success:"label-success",warning:"label-warning",danger:"label-danger"}},elements:{start:$("#servers")},texts:{fetching:"Fetching...",pinging:"Pinging...",status:{offline:"Offline"}}},this.start()}function Hub(id,configs){this.servers=[],this.online=0,this.max=0,this.name="Fetching...",this.id=id,this.configs=configs}function Server(id,configs){this.configs=configs,this.id=id,this.name=this.configs.texts.fetching,this.players={online:0,max:0,sample:[]},this.version=[],this.favicon=null,this.description=null,this.element=null,this.ping=0}function ServerRepository(){this.servers=[],this.totalMax=0,this.totalOnline=0,this.draw()}App.prototype.start=function(){var serverRepository=new ServerRepository;$.ajax({type:"POST",url:this.url+"/index.php?COMMAND=getserverids",cache:!0,dataType:"json",timeout:5e3,context:this,success:function(servers){for(var i in servers){if(servers[i]instanceof Array){hub=new Hub(i,this.configs);for(var j=0;j<servers[i].length;j++)hub.addServer(new Server(j,this.configs));serverRepository.addServer(hub),hub.draw(this.configs.elements.start)}else server=new Server(servers[i],this.configs),serverRepository.addServer(server),server.draw(this.configs.elements.start);serverRepository.retrieveData(i)}setInterval(function(){serverRepository.refreshAll()},1e4)},error:function(request,status){"timeout"==status?this.servers[id].reset():(console.log(request.responseText),this.servers[id].reset())}})},Hub.prototype.addServer=function(server){this.servers.push(server)},Hub.prototype.calculatePercentage=function(){return 0==this.max?0:this.online/this.max*100},Hub.prototype.calculateOnlinePlayers=function(){this.online=0;for(var i in this.servers)this.online+=this.servers[i].players.online;return this.online},Hub.prototype.calculateMaxPlayers=function(){this.max=0;for(var i in this.servers)this.max+=this.servers[i].players.max;return this.max},Hub.prototype.calculateTotalPing=function(){for(var totalping=0,i=0;i<this.servers.length;i++)totalping+=parseInt(Math.ceil(this.servers[i].ping));return Math.ceil(totalping/this.servers.length)},Hub.prototype.reset=function(){var status=this.element.find(".label");status.removeClass().addClass("label label-danger"),status.text("Offline")},Hub.prototype.update=function(){var progressbar=this.element.find(".progress .progress-bar");progressbar.css("width",this.calculatePercentage()+"%"),progressbar.text(this.calculateOnlinePlayers()+"/"+this.calculateMaxPlayers());var title=this.element.find(".title-text");title.text(this.name);var status=this.element.find(".label");status.hasClass(this.configs.classes.ping.warning)&&status.removeClass(this.configs.classes.ping.warning);var ping=this.calculateTotalPing();0==ping?(status.removeClass(this.configs.classes.ping.success).addClass(this.configs.classes.ping.danger),status.text(this.configs.texts.status.offline)):(status.removeClass(this.configs.classes.ping.danger).addClass(this.configs.classes.ping.success),status.text(ping+"ms"))},Hub.prototype.draw=function(){var id1=$('<div id="server-'+this.id+'"></div>'),id2=$('<h5><span class="title-text">'+this.name+"</span></h5>"),ping=this.calculateTotalPing(),id3=$('<span style="float:right;" class="label '+this.configs.classes.ping.success+'"></span>').text(ping+"ms");0==ping&&id3.removeClass(this.configs.classes.ping.success).addClass(this.configs.classes.ping.success).text(this.configs.texts.pinging);var id4=$('<div class="'+this.configs.classes.progress+'"></div>'),id5=$('<span class="bar-text"></span>'),id6=$('<div class="'+this.configs.classes.progressbar+'" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: '+this.calculatePercentage()+'%;"></div>').text(this.calculateOnlinePlayers()+"/"+this.calculateMaxPlayers());id2.append(id3),id2.append(id3),id1.append(id2),id1.append(id4),id4.append(id5),id4.append(id6),this.configs.elements.start.append(id1),this.element=id1,this.drawn=!0},Server.prototype.calculatePercentage=function(){return 0==this.players.max?0:this.players.online/this.players.max*100},Server.prototype.calculateOnlinePlayers=function(){return this.players.online},Server.prototype.calculateMaxPlayers=function(){return this.players.max},Server.prototype.reset=function(){var status=this.element.find(".label");status.removeClass().addClass("label label-danger"),status.text(this.configs.texts.status.offline)},Server.prototype.update=function(){var progressbar=this.element.find(".progress .progress-bar");progressbar.css("width",this.calculatePercentage()+"%"),progressbar.text(this.players.online+"/"+this.players.max);var title=this.element.find(".title-text");title.text(this.name);var status=this.element.find(".label");status.hasClass(this.configs.classes.ping.warning)&&status.removeClass(this.configs.classes.ping.warning),0==this.ping?(status.removeClass(this.configs.classes.ping.success).addClass(this.configs.classes.ping.danger),status.text(this.configs.texts.status.offline)):(status.removeClass(this.configs.classes.ping.danger).addClass(this.configs.classes.ping.success),status.text(Math.floor(this.ping)+"ms"))},Server.prototype.draw=function(){var id1=$('<div id="server-'+this.id+'"></div>'),id2=$('<h5><span class="title-text">'+this.name+"</span></h5>"),id3=$('<span style="float:right;" class="label '+this.configs.classes.ping.success+'"></span>').text(Math.floor(this.ping)+"ms");0==this.ping&&id3.removeClass(this.configs.classes.ping.success).addClass(this.configs.classes.ping.success).text(this.configs.texts.pinging);var id4=$('<div class="'+this.configs.classes.progress+'"></div>'),id5=$('<span class="bar-text"></span>'),id6=$('<div class="'+this.configs.classes.progressbar+'" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: '+this.calculatePercentage()+'%;"></div>').text(this.calculateOnlinePlayers()+"/"+this.calculateMaxPlayers());id2.append(id3),id2.append(id3),id1.append(id2),id1.append(id4),id4.append(id5),id4.append(id6),this.configs.elements.start.append(id1),this.element=id1,this.drawn=!0},ServerRepository.prototype.addServer=function(server){this.servers.push(server)},ServerRepository.prototype.retrieveData=function(id){$.ajax({type:"POST",url:"index.php",cache:!1,data:{id:this.servers[id].id},dataType:"json",timeout:5e3,context:this,success:function(data){if(this.servers[id]instanceof Hub){for(var hub=this.servers[id],tmpServers=hub.servers,i=0;i<tmpServers.length;i++)if("undefined"!=typeof data[i]){var tmpServer=JSON.parse(data[i]);"undefined"!=typeof tmpServer.error&&1==tmpServer.error?hub.name=tmpServers.name:(tmpServers[i].description=tmpServer.description,tmpServers[i].version=tmpServer.version,tmpServers[i].favicon=tmpServer.favicon,tmpServers[i].ping=tmpServer.ping,tmpServers[i].players.online=tmpServer.players.online,tmpServers[i].players.max=tmpServer.players.max,tmpServers[i].ping=tmpServer.ping,tmpServers[i].count=tmpServer.count,hub.name=tmpServer.name),this.servers[id].update()}}else"undefined"!=typeof data.error&&1==data.error?this.servers[id].name=data.name:(this.servers[id].description=data.description,this.servers[id].version=data.version,this.servers[id].favicon=data.favicon,this.servers[id].ping=data.ping,this.servers[id].players.online=data.players.online,this.servers[id].players.max=data.players.max,this.servers[id].name=data.name,this.servers[id].count=data.count,"undefined"!=typeof data.players.sample&&(this.servers[id].players.sample=data.players.sample)),this.servers[id].update();this.calculateTotals(),this.update()},error:function(request,status){"timeout"==status?this.servers[id].reset():(console.log(request.responseText),this.servers[id].reset())}})},ServerRepository.prototype.getServers=function(){return this.servers},ServerRepository.prototype.refresh=function(id){this.retrieveData(id),this.calculateTotals(),this.update()},ServerRepository.prototype.refreshAll=function(){for(var i=0;i<this.servers.length;i++)this.retrieveData(this.servers[i].id),this.calculateTotals(),this.update()},ServerRepository.prototype.update=function(){$("#total-online").text("Total: "+this.totalOnline)},ServerRepository.prototype.draw=function(){var container=$('<h6 id="total-online"></div>').text("Total: "+this.totalOnline);$("#servers").after(container)},ServerRepository.prototype.calculateTotals=function(){for(var totalOnline=0,totalMax=0,i=0;i<this.servers.length;i++)this.servers[i]instanceof Hub&&1==this.servers[i].count?(totalOnline+=this.servers[i].calculateOnlinePlayers(),totalMax+=this.servers[i].calculateMaxPlayers()):1==this.servers[i].count&&(totalOnline+=parseInt(this.servers[i].players.online),totalMax+=parseInt(this.servers[i].players.max));this.totalOnline=totalOnline,this.totalMax=totalMax};